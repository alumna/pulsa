"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var fs=_interopDefault(require("fs")),path=require("path"),stream=require("stream");function Mime(){this._types=Object.create(null),this._extensions=Object.create(null);for(var e=0;e<arguments.length;e++)this.define(arguments[e]);this.define=this.define.bind(this),this.getType=this.getType.bind(this),this.getExtension=this.getExtension.bind(this)}Mime.prototype.define=function(e,t){for(var i in e){var a=e[i].map(function(e){return e.toLowerCase()});i=i.toLowerCase();for(var p=0;p<a.length;p++){if("*"!=(s=a[p])[0]){if(!t&&s in this._types)throw new Error('Attempt to change mapping for "'+s+'" extension from "'+this._types[s]+'" to "'+i+'". Pass `force=true` to allow this, otherwise remove "'+s+'" from the list of extensions for "'+i+'".');this._types[s]=i}}if(t||!this._extensions[i]){var s=a[0];this._extensions[i]="*"!=s[0]?s:s.substr(1)}}},Mime.prototype.getType=function(e){var t=(e=String(e)).replace(/^.*[\/\\]/,"").toLowerCase(),i=t.replace(/^.*\./,"").toLowerCase(),a=t.length<e.length;return(i.length<t.length-1||!a)&&this._types[i]||null},Mime.prototype.getExtension=function(e){return(e=/^\s*([^;\s]*)/.test(e)&&RegExp.$1)&&this._extensions[e.toLowerCase()]||null};var Mime_1=Mime,standard={"application/andrew-inset":["ez"],"application/applixware":["aw"],"application/atom+xml":["atom"],"application/atomcat+xml":["atomcat"],"application/atomsvc+xml":["atomsvc"],"application/bdoc":["bdoc"],"application/ccxml+xml":["ccxml"],"application/cdmi-capability":["cdmia"],"application/cdmi-container":["cdmic"],"application/cdmi-domain":["cdmid"],"application/cdmi-object":["cdmio"],"application/cdmi-queue":["cdmiq"],"application/cu-seeme":["cu"],"application/dash+xml":["mpd"],"application/davmount+xml":["davmount"],"application/docbook+xml":["dbk"],"application/dssc+der":["dssc"],"application/dssc+xml":["xdssc"],"application/ecmascript":["ecma","es"],"application/emma+xml":["emma"],"application/epub+zip":["epub"],"application/exi":["exi"],"application/font-tdpfr":["pfr"],"application/geo+json":["geojson"],"application/gml+xml":["gml"],"application/gpx+xml":["gpx"],"application/gxf":["gxf"],"application/gzip":["gz"],"application/hjson":["hjson"],"application/hyperstudio":["stk"],"application/inkml+xml":["ink","inkml"],"application/ipfix":["ipfix"],"application/java-archive":["jar","war","ear"],"application/java-serialized-object":["ser"],"application/java-vm":["class"],"application/javascript":["js","mjs"],"application/json":["json","map"],"application/json5":["json5"],"application/jsonml+json":["jsonml"],"application/ld+json":["jsonld"],"application/lost+xml":["lostxml"],"application/mac-binhex40":["hqx"],"application/mac-compactpro":["cpt"],"application/mads+xml":["mads"],"application/manifest+json":["webmanifest"],"application/marc":["mrc"],"application/marcxml+xml":["mrcx"],"application/mathematica":["ma","nb","mb"],"application/mathml+xml":["mathml"],"application/mbox":["mbox"],"application/mediaservercontrol+xml":["mscml"],"application/metalink+xml":["metalink"],"application/metalink4+xml":["meta4"],"application/mets+xml":["mets"],"application/mods+xml":["mods"],"application/mp21":["m21","mp21"],"application/mp4":["mp4s","m4p"],"application/msword":["doc","dot"],"application/mxf":["mxf"],"application/n-quads":["nq"],"application/n-triples":["nt"],"application/octet-stream":["bin","dms","lrf","mar","so","dist","distz","pkg","bpk","dump","elc","deploy","exe","dll","deb","dmg","iso","img","msi","msp","msm","buffer"],"application/oda":["oda"],"application/oebps-package+xml":["opf"],"application/ogg":["ogx"],"application/omdoc+xml":["omdoc"],"application/onenote":["onetoc","onetoc2","onetmp","onepkg"],"application/oxps":["oxps"],"application/patch-ops-error+xml":["xer"],"application/pdf":["pdf"],"application/pgp-encrypted":["pgp"],"application/pgp-signature":["asc","sig"],"application/pics-rules":["prf"],"application/pkcs10":["p10"],"application/pkcs7-mime":["p7m","p7c"],"application/pkcs7-signature":["p7s"],"application/pkcs8":["p8"],"application/pkix-attr-cert":["ac"],"application/pkix-cert":["cer"],"application/pkix-crl":["crl"],"application/pkix-pkipath":["pkipath"],"application/pkixcmp":["pki"],"application/pls+xml":["pls"],"application/postscript":["ai","eps","ps"],"application/pskc+xml":["pskcxml"],"application/raml+yaml":["raml"],"application/rdf+xml":["rdf","owl"],"application/reginfo+xml":["rif"],"application/relax-ng-compact-syntax":["rnc"],"application/resource-lists+xml":["rl"],"application/resource-lists-diff+xml":["rld"],"application/rls-services+xml":["rs"],"application/rpki-ghostbusters":["gbr"],"application/rpki-manifest":["mft"],"application/rpki-roa":["roa"],"application/rsd+xml":["rsd"],"application/rss+xml":["rss"],"application/rtf":["rtf"],"application/sbml+xml":["sbml"],"application/scvp-cv-request":["scq"],"application/scvp-cv-response":["scs"],"application/scvp-vp-request":["spq"],"application/scvp-vp-response":["spp"],"application/sdp":["sdp"],"application/set-payment-initiation":["setpay"],"application/set-registration-initiation":["setreg"],"application/shf+xml":["shf"],"application/sieve":["siv","sieve"],"application/smil+xml":["smi","smil"],"application/sparql-query":["rq"],"application/sparql-results+xml":["srx"],"application/srgs":["gram"],"application/srgs+xml":["grxml"],"application/sru+xml":["sru"],"application/ssdl+xml":["ssdl"],"application/ssml+xml":["ssml"],"application/tei+xml":["tei","teicorpus"],"application/thraud+xml":["tfi"],"application/timestamped-data":["tsd"],"application/voicexml+xml":["vxml"],"application/wasm":["wasm"],"application/widget":["wgt"],"application/winhlp":["hlp"],"application/wsdl+xml":["wsdl"],"application/wspolicy+xml":["wspolicy"],"application/xaml+xml":["xaml"],"application/xcap-diff+xml":["xdf"],"application/xenc+xml":["xenc"],"application/xhtml+xml":["xhtml","xht"],"application/xml":["xml","xsl","xsd","rng"],"application/xml-dtd":["dtd"],"application/xop+xml":["xop"],"application/xproc+xml":["xpl"],"application/xslt+xml":["xslt"],"application/xspf+xml":["xspf"],"application/xv+xml":["mxml","xhvml","xvml","xvm"],"application/yang":["yang"],"application/yin+xml":["yin"],"application/zip":["zip"],"audio/3gpp":["*3gpp"],"audio/adpcm":["adp"],"audio/basic":["au","snd"],"audio/midi":["mid","midi","kar","rmi"],"audio/mp3":["*mp3"],"audio/mp4":["m4a","mp4a"],"audio/mpeg":["mpga","mp2","mp2a","mp3","m2a","m3a"],"audio/ogg":["oga","ogg","spx"],"audio/s3m":["s3m"],"audio/silk":["sil"],"audio/wav":["wav"],"audio/wave":["*wav"],"audio/webm":["weba"],"audio/xm":["xm"],"font/collection":["ttc"],"font/otf":["otf"],"font/ttf":["ttf"],"font/woff":["woff"],"font/woff2":["woff2"],"image/aces":["exr"],"image/apng":["apng"],"image/bmp":["bmp"],"image/cgm":["cgm"],"image/dicom-rle":["drle"],"image/emf":["emf"],"image/fits":["fits"],"image/g3fax":["g3"],"image/gif":["gif"],"image/heic":["heic"],"image/heic-sequence":["heics"],"image/heif":["heif"],"image/heif-sequence":["heifs"],"image/ief":["ief"],"image/jls":["jls"],"image/jp2":["jp2","jpg2"],"image/jpeg":["jpeg","jpg","jpe"],"image/jpm":["jpm"],"image/jpx":["jpx","jpf"],"image/jxr":["jxr"],"image/ktx":["ktx"],"image/png":["png"],"image/sgi":["sgi"],"image/svg+xml":["svg","svgz"],"image/t38":["t38"],"image/tiff":["tif","tiff"],"image/tiff-fx":["tfx"],"image/webp":["webp"],"image/wmf":["wmf"],"message/disposition-notification":["disposition-notification"],"message/global":["u8msg"],"message/global-delivery-status":["u8dsn"],"message/global-disposition-notification":["u8mdn"],"message/global-headers":["u8hdr"],"message/rfc822":["eml","mime"],"model/3mf":["3mf"],"model/gltf+json":["gltf"],"model/gltf-binary":["glb"],"model/iges":["igs","iges"],"model/mesh":["msh","mesh","silo"],"model/stl":["stl"],"model/vrml":["wrl","vrml"],"model/x3d+binary":["*x3db","x3dbz"],"model/x3d+fastinfoset":["x3db"],"model/x3d+vrml":["*x3dv","x3dvz"],"model/x3d+xml":["x3d","x3dz"],"model/x3d-vrml":["x3dv"],"text/cache-manifest":["appcache","manifest"],"text/calendar":["ics","ifb"],"text/coffeescript":["coffee","litcoffee"],"text/css":["css"],"text/csv":["csv"],"text/html":["html","htm","shtml"],"text/jade":["jade"],"text/jsx":["jsx"],"text/less":["less"],"text/markdown":["markdown","md"],"text/mathml":["mml"],"text/mdx":["mdx"],"text/n3":["n3"],"text/plain":["txt","text","conf","def","list","log","in","ini"],"text/richtext":["rtx"],"text/rtf":["*rtf"],"text/sgml":["sgml","sgm"],"text/shex":["shex"],"text/slim":["slim","slm"],"text/stylus":["stylus","styl"],"text/tab-separated-values":["tsv"],"text/troff":["t","tr","roff","man","me","ms"],"text/turtle":["ttl"],"text/uri-list":["uri","uris","urls"],"text/vcard":["vcard"],"text/vtt":["vtt"],"text/xml":["*xml"],"text/yaml":["yaml","yml"],"video/3gpp":["3gp","3gpp"],"video/3gpp2":["3g2"],"video/h261":["h261"],"video/h263":["h263"],"video/h264":["h264"],"video/jpeg":["jpgv"],"video/jpm":["*jpm","jpgm"],"video/mj2":["mj2","mjp2"],"video/mp2t":["ts"],"video/mp4":["mp4","mp4v","mpg4"],"video/mpeg":["mpeg","mpg","mpe","m1v","m2v"],"video/ogg":["ogv"],"video/quicktime":["qt","mov"],"video/webm":["webm"]},lite=new Mime_1(standard),url=function(e){let t=e.url;if(void 0===t)return t;let i=e._parsedUrl;if(i&&i._raw===t)return i;(i={}).query=i.search=null,i.href=i.path=i.pathname=t;let a=t.indexOf("?",1);return-1!==a&&(i.search=t.substring(a),i.query=i.search.substring(1),i.pathname=t.substring(0,a)),i._raw=t,e._parsedUrl=i};const readStream=fs.createReadStream,read=fs.readFileSync,caching={},map={};let instances=0;const instance={},serve=function(e){"string"==typeof e&&(e={dir:e});const t=Object.assign({base:"/",dir:".",maxFileSize:1048576,spa:!1},e);return t.id=++instances,instance[t.id]=t,t.dir=path.resolve(t.dir),t.responses={},t.base=alias(t.base,t),cache(t.base,t),async function(e,i,a){const p=decodeURIComponent(e.path||e.pathname||url(e).pathname);return(t.responses[p]||(t.responses[p]=await cache(p,t)))(e,i,a)}},cache=async function(e,t){let i=path.join(t.dir,alias(e,t));if(i.endsWith(path.sep)&&(i=i.slice(0,-1)),caching[i])return caching[i];ensure(i),reverse(i,t,e);const a=map[i],{stop:p,sufix:s}=check_index(i);if(p){let i=path.join(t.dir,t.base.endsWith("/")?t.base.slice(0,-1):t.base);return t.spa?(reverse(i,t,e),a.response=caching[i]):a.response=notFound}reverse(i+s,t,e);const n=map[i+s];return a.stream=n.stream=a.stream||n.stream||cache_stream(i+s,t,null,a),a.response=n.response=a.response||n.response||response(i,s,a),caching[i]=caching[i+s]=a.response},ensure=e=>{map[e]||(map[e]={reverses:{},ranges:{}})},reverse=(e,t,i)=>{map[e].reverses[t.id]||(map[e].reverses[t.id]={}),map[e].reverses[t.id][i]=!0},memory=function(e,t){e=path.resolve(e),ensure(e),t instanceof Buffer||(t=Buffer.from(t));const i=map[e];return i.charset="utf-8",i.stats={size:t.length,mtime:new Date,isDirectory:()=>!1},i.stream=cache_stream(e,null,t,i),i.response=caching[e]=response(e,"",i),update_instances(e,i.response),e.endsWith(path.sep+"index.html")&&clear(e.slice(0,-11),!1),!0},update_instances=function(e,t,i=!1){if(!map[e])return;const a=map[e];for(let e in a.reverses){const p=a.reverses[e],s=instance[e];for(let e in p)i?delete s.responses[e]:s.responses[e]=t}},check_index=function(e){let t="";return!check(e)||map[e].stats.isDirectory()&&(!check(e+(t=path.sep+"index.html"))||map[e+t].stats.isDirectory())?{stop:!0}:{stop:!1,sufix:t}},check=function(e){if(ensure(e),map[e].stats)return!0;try{return map[e].stats=fs.statSync(e),!0}catch(e){return!1}},cache_stream=function(e,t,i,a){return t&&a.stats.size>t.maxFileSize?a.stream=(t,i)=>readStream(e,i).pipe(t):(a.data=i||read(e),a.stream=(e,t)=>{const i=new stream.Readable;i.push(t.end?a.data.slice(t.start,t.end+1):a.data),i.push(null),i.pipe(e)})},cache_range=function(e,t,i){const a={},p=i.stats.size;let[s,n]=e.replace("bytes=","").split("-"),o=a.end=parseInt(n,10)||p-1,l=a.start=parseInt(s,10)||0;if(l>=p||o>=p){const e=`bytes */${p}`;return function(t){return t.setHeader("Content-Range",e),t.statusCode=416,t.end()}}const c={"Content-Range":`bytes ${l}-${o}/${p}`,"Content-Length":o-l+1,"Accept-Ranges":"bytes","Content-Type":t["Content-Type"],"Last-Modified":t["Last-Modified"]};return function(e){e.writeHead(206,c),i.stream(e,a)}},response=function(e,t,i){const a=t?map[e+t]:i;return i.headers={"Content-Length":a.stats.size,"Content-Type":lite.getType(e)+(i.charset?"; charset="+i.charset:""),"Last-Modified":a.stats.mtime.toUTCString()},i.response=a.response=function(e,t){if(e.headers.range){const p=e.headers.range;(i.ranges[p]||(i.ranges[p]=cache_range(p,i.headers,a)))(t)}else t.writeHead(200,i.headers),a.stream(t,{})}},alias=function(e,t){if(!t.alias||"object"!=typeof t.alias)return e;for(let i in t.alias)if(e.startsWith(i))return e.replace(i,t.alias[i]);return e},notFound=function(e,t,i){return i?i():(t.statusCode=404,t.end())},clear=function(e,t=!0){if(e)return e.length>1&&e.endsWith(path.sep)&&(e=e.slice(0,-1)),t&&(e.endsWith(path.sep+"index.html")?clear(e.slice(0,-11),!1):map[e]&&map[e].stats&&map[e].stats.isDirectory()&&clear(e+path.sep+"index.html",!1)),update_instances(e,null,!0),delete map[e],delete caching[e],!0};var index={serve:serve,memory:memory,clear:clear};module.exports=index;
